<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="_layout_conductor">
<head>
    <title>UTP Integrador - Vehículos</title>
</head>
<body>
<div layout:fragment="content" id="vehiculosApp" class="container mt-4">
    <h1>Gestión de Vehículos</h1>

    <div class="mb-3">
        <input type="text" class="form-control" placeholder="Buscar por Placa..." v-model="searchPlaca"
               @input="debouncedSearch">
    </div>

    <p class="text-end">
        <button class="btn btn-primary" @click="nuevo">Nuevo Vehículo</button>
    </p>

    <table class="table table-striped table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>Placa</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Año</th>
            <th>Color</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="item in entidades" :key="item.id">
            <td>{{item.id}}</td>
            <td>{{item.placa}}</td>
            <td>{{item.marca}}</td>
            <td>{{item.modelo}}</td>
            <td>{{item.anio}}</td>
            <td>{{item.color}}</td>
            <td class="text-end">
                <button class="btn btn-info me-2" @click="editar(item.id)" title="Editar">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-danger" @click="eliminar(item.id)" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        <tr v-if="entidades.length === 0">
            <td colspan="7" class="text-center">No hay vehículos registrados o no se encontraron resultados.</td>
        </tr>
        </tbody>
    </table>

    <!-- Modal de Crear/Editar -->
    <div class="modal fade" tabindex="-1" id="mdlEntidad" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle" v-if="entidad.id == null">Nuevo Vehículo</h5>
                    <h5 class="modal-title" id="modalTitle" v-else>Editar Vehículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">Placa</label>
                        <div class="col-sm-8">
                            <input class="form-control" v-model="entidad.placa" required maxlength="10"/>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">Marca</label>
                        <div class="col-sm-8">
                            <input class="form-control" v-model="entidad.marca" required/>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">Modelo</label>
                        <div class="col-sm-8">
                            <input class="form-control" v-model="entidad.modelo" required/>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">Año</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" v-model.number="entidad.anio" min="1900" max="2100" required/>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-4 col-form-label">Color</label>
                        <div class="col-sm-8">
                            <input class="form-control" v-model="entidad.color" required/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" v-if="entidad.id == null" @click="guardar">Guardar</button>
                    <button type="button" class="btn btn-primary" v-else @click="actualizar">Actualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Eliminación -->
    <div class="modal fade" tabindex="-1" id="mdlEliminar" aria-labelledby="deleteModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalTitle">Eliminar Vehículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro que quieres eliminar este vehículo?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" @click="confirmarEliminacion">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script">
    const API_VEHICULOS_URL = '/api/vehiculos';

    function debounce(fn, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                fn.apply(this, args);
            }, delay);
        };
    }

    new Vue({
        el: "#vehiculosApp",
        data: {
            entidades: [],
            entidad: { id: null, placa: '', marca: '', modelo: '', anio: 2023, color: '' },
            searchPlaca: '',
            idToDelete: null
        },
        methods: {
            listar: function () {
                let url = API_VEHICULOS_URL;
                if (this.searchPlaca) {
                    url += '?placa=' + encodeURIComponent(this.searchPlaca);
                }
                this.$http.get(url).then(response => {
                    this.entidades = response.data;
                }).catch(error => {
                    console.error("Error al obtener vehículos:", error);
                    this.entidades = [];
                });
            },
            nuevo: function () {
                this.entidad = { id: null, placa: '', marca: '', modelo: '', anio: 2023, color: '' };
                $("#mdlEntidad").modal("show");
            },
            editar: function (id) {
                this.$http.get(API_VEHICULOS_URL + '/' + id).then(response => {
                    this.entidad = response.data;
                    $("#mdlEntidad").modal("show");
                });
            },
            guardar: function () {
                this.$http.post(API_VEHICULOS_URL, this.entidad).then(response => {
                    this.listar();
                    $("#mdlEntidad").modal("hide");
                });
            },
            actualizar: function () {
                this.$http.put(API_VEHICULOS_URL + '/' + this.entidad.id, this.entidad).then(response => {
                    this.listar();
                    $("#mdlEntidad").modal("hide");
                });
            },
            eliminar: function (id) {
                this.idToDelete = id;
                $("#mdlEliminar").modal("show");
            },
            confirmarEliminacion: function () {
                this.$http.delete(API_VEHICULOS_URL + '/' + this.idToDelete).then(response => {
                    this.listar();
                    $("#mdlEliminar").modal("hide");
                    this.idToDelete = null;
                });
            },
            debouncedSearch: debounce(function() {
                this.listar();
            }, 500)
        },
        mounted: function () {
            this.listar();
        }
    });
</script>
</body>
</html>