<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="_layout_dueno">
<head>
    <title>Gestión de Proveedores</title>
    <style>
        .main-content {
            margin-right: 240px;
            padding: 80px 2rem 2rem 2rem;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .search-input {
            max-width: 300px;
        }
    </style>
</head>
<body>
<div layout:fragment="content" id="proveedoresApp" class="container mt-4">
    <h1>Gestión de Proveedores</h1>

    <div class="mb-3">
        <input type="text" class="form-control" placeholder="Buscar por RUC o Razón Social..."
               v-model="search" @input="debouncedSearch">
    </div>

    <p class="text-end">
        <button class="btn btn-primary" @click="nuevo">Nuevo Proveedor</button>
    </p>

    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>RUC</th>
            <th>Razón Social</th>
            <th>Teléfono</th>
            <th>Correo</th>
            <th>Dirección</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="item in entidades" :key="item.id">
            <td>{{ item.id }}</td>
            <td>{{ item.ruc }}</td>
            <td>{{ item.razonSocial }}</td>
            <td>{{ item.telefono }}</td>
            <td>{{ item.correo }}</td>
            <td>{{ item.direccion }}</td>
            <td class="text-end">
                <button class="btn btn-info btn-sm me-1" @click="editar(item.id)" title="Editar">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-danger btn-sm" @click="eliminar(item.id)" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        <tr v-if="entidades.length === 0">
            <td colspan="7" class="text-center">No hay proveedores registrados.</td>
        </tr>
        </tbody>
    </table>

    <!-- Modal Crear/Editar -->
    <div class="modal fade" id="mdlEntidad" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ entidad.id ? 'Editar Proveedor' : 'Nuevo Proveedor' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>RUC</label>
                        <input class="form-control" v-model="entidad.ruc" required maxlength="11">
                    </div>
                    <div class="mb-3">
                        <label>Razón Social</label>
                        <input class="form-control" v-model="entidad.razonSocial" required>
                    </div>
                    <div class="mb-3">
                        <label>Teléfono</label>
                        <input class="form-control" v-model="entidad.telefono" maxlength="20">
                    </div>
                    <div class="mb-3">
                        <label>Correo</label>
                        <input class="form-control" type="email" v-model="entidad.correo">
                    </div>
                    <div class="mb-3">
                        <label>Dirección</label>
                        <input class="form-control" v-model="entidad.direccion">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @click="entidad.id ? actualizar() : guardar()">
                        {{ entidad.id ? 'Actualizar' : 'Guardar' }}
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar -->
    <div class="modal fade" id="mdlEliminar" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Estás seguro de eliminar este proveedor?</div>
                <div class="modal-footer">
                    <button class="btn btn-danger" @click="confirmarEliminacion">Eliminar</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script">
    const API_PROVEEDORES_URL = '/api/proveedores';

    function debounce(fn, delay) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    new Vue({
        el: '#proveedoresApp',
        data: {
            entidades: [],
            entidad: { id: null, ruc: '', razonSocial: '', telefono: '', correo: '', direccion: '' },
            search: '',
            idToDelete: null
        },
        methods: {
            listar() {
                this.$http.get(API_PROVEEDORES_URL).then(res => this.entidades = res.data);
            },
            nuevo() {
                this.entidad = { id: null, ruc: '', razonSocial: '', telefono: '', correo: '', direccion: '' };
                $('#mdlEntidad').modal('show');
            },
            editar(id) {
                this.$http.get(`${API_PROVEEDORES_URL}/${id}`).then(res => {
                    this.entidad = res.data;
                    $('#mdlEntidad').modal('show');
                });
            },
            guardar() {
                this.$http.post(API_PROVEEDORES_URL, this.entidad).then(() => {
                    this.listar();
                    $('#mdlEntidad').modal('hide');
                });
            },
            actualizar() {
                this.$http.put(`${API_PROVEEDORES_URL}/${this.entidad.id}`, this.entidad).then(() => {
                    this.listar();
                    $('#mdlEntidad').modal('hide');
                });
            },
            eliminar(id) {
                this.idToDelete = id;
                $('#mdlEliminar').modal('show');
            },
            confirmarEliminacion() {
                this.$http.delete(`${API_PROVEEDORES_URL}/${this.idToDelete}`).then(() => {
                    this.listar();
                    $('#mdlEliminar').modal('hide');
                    this.idToDelete = null;
                });
            },
            debouncedSearch: debounce(function () {
                const filtro = this.search.toLowerCase();
                if (!filtro) {
                    this.listar();
                } else {
                    this.entidades = this.entidades.filter(p =>
                        p.ruc.toLowerCase().includes(filtro) || p.razonSocial.toLowerCase().includes(filtro)
                    );
                }
            }, 400)
        },
        mounted() {
            this.listar();
        }
    });
</script>
</body>
</html>