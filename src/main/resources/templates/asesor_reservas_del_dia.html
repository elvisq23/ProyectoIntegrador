<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_layout_asesor">
    <head>
        <title>UTP Integrador - asesor</title>
            <style>
        .main-content {
            margin-right: 240px;
            padding: 80px 2rem 2rem 2rem;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .search-input {
            max-width: 300px;
        }
    </style>
        </head>
<body>
  <div layout:fragment="content" id="appLlegadas">
    <!-- Contenido principal -->
    <div class="main-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Registro de Vehículos</h1>

        <button class="btn btn-success me-3" @click="abrirModalNueva">
          Nuevo&nbsp;<strong>+</strong>
        </button>

        <input type="text" class="form-control w-50" v-model="filtro" placeholder="Buscar por placa…"/>
      </div>

      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Hora</th>
            <th>Vehículo / Modelo</th>
            <th>Placa</th>
            <th>Taller</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, i) in llegadasFiltradas" :key="item.id">
            <td>{{ i + 1 }}</td>
            <td>{{ new Date(item.fechaHora).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) }}</td>
            <td>{{ item.vehiculo }} {{ item.modelo }}</td>
            <td>{{ item.placa }}</td>
            <td>{{ item.taller }}</td>
            <td>{{ item.estado }}</td>
            <td>
              <button class="btn btn-warning btn-sm" @click="abrirModalEditar(item)">
                Editar
              </button>
            </td>
          </tr>
          <tr v-if="!llegadasFiltradas.length">
            <td colspan="7" class="text-center text-muted">Sin registros</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Modal Nueva / Editar llegada -->
    <div class="modal fade" id="modalLlegada" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ llegada.id ? 'Editar' : 'Nueva' }} llegada</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Vehículo</label>
              <input type="text" class="form-control" v-model="llegada.vehiculo"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Modelo</label>
              <input type="text" class="form-control" v-model="llegada.modelo"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Placa</label>
              <input type="text" class="form-control" v-model="llegada.placa"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Taller</label>
              <input type="text" class="form-control" v-model="llegada.taller"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Estado</label>
              <select class="form-control" v-model="llegada.estado">
                <option value="En reparación">En reparación</option>
                <option value="Listo para recoger">Listo para recoger</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Hora</label>
              <input type="datetime-local" class="form-control" v-model="llegada.fechaHora"/>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" @click="guardarLlegada">Guardar</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue Script -->
  <script layout:fragment="script">
    new Vue({
      el: "#appLlegadas",
      data() {
        return {
          llegadas: [],
          filtro: "",
          llegada: {
            id: null,
            vehiculo: "",
            modelo: "",
            placa: "",
            taller: "",
            estado: "En reparación",
            fechaHora: "",
          },
        };
      },
      computed: {
        llegadasFiltradas() {
          const t = this.filtro.trim().toLowerCase();
          return this.llegadas.filter((l) =>
            l.placa.toLowerCase().includes(t)
          );
        },
      },
      methods: {
        listar() {
          this.$http.get("/api/llegadas").then((res) => {
            this.llegadas = res.data;
          });
        },
        abrirModalNueva() {
          this.llegada = {
            id: null,
            vehiculo: "",
            modelo: "",
            placa: "",
            taller: "",
            estado: "En reparación",
            fechaHora: new Date().toISOString().slice(0, 16),
          };
          new bootstrap.Modal(document.getElementById("modalLlegada")).show();
        },
        abrirModalEditar(item) {
          this.llegada = { ...item };
          this.llegada.fechaHora = item.fechaHora.slice(0, 16);
          new bootstrap.Modal(document.getElementById("modalLlegada")).show();
        },
        guardarLlegada() {
          const carga = { ...this.llegada };
          if (typeof carga.fechaHora === "string") {
            carga.fechaHora = new Date(carga.fechaHora).toISOString();
          }

          if (carga.id) {
            this.$http.put(`/api/llegadas/${carga.id}`, carga).then(() => {
              bootstrap.Modal.getInstance(document.getElementById("modalLlegada")).hide();
              this.listar();
            });
          } else {
            this.$http.post("/api/llegadas", carga).then(() => {
              bootstrap.Modal.getInstance(document.getElementById("modalLlegada")).hide();
              this.listar();
            });
          }
        },
      },
      mounted() {
        this.listar();
      },
    });
  </script>
</body>

</html>